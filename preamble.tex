\PassOptionsToPackage{dvipsnames,table,usenames,svgnames}{xcolor}
\documentclass[a4paper, 10pt, openright,twoside,onecolumn]{memoir}

\usepackage{asymptote}
\def\asydir{asydir}

\usepackage{marginnote}
\def\blank#1{\rule{#1}{0.5pt}}


\usepackage{lipsum}
\usepackage{tikz}
\usepackage{xcolor}

% ==> language
\usepackage[no-math]{fontspec}
\usepackage{fontawesome}
\usepackage[Khmer, Latin]{ucharclasses}
\usepackage{etoolbox}
\usepackage{enumitem}

% ==> main font
\setmainfont[
	BoldFont = Kdam Thmor,
	ItalicFont = Khmer OS Metal Chrieng,
	BoldItalicFont = Khmer OS Muol,
	SmallCapsFont = TeX Gyre Pagella,
	Script=Khmer,Scale=1
]{Khmer OS Siemreap}

\XeTeXlinebreaklocale "kh"
\XeTeXlinebreakskip = 0pt plus 1pt minus 1pt


\newfontfamily{\khmerfamily}
[
	BoldFont = Kdam Thmor,
	ItalicFont = Khmer OS Metal Chrieng,
	BoldItalicFont = Khmer OS Muol,
	SmallCapsFont = TeX Gyre Pagella,
	Script=Khmer,Scale=1
]{Khmer OS Siemreap}
\newfontfamily{\englishfamily}{TeX Gyre Pagella}[Ligatures=TeX, Scale=1.1]
\newfontfamily{\monofamily}[Scale=1.3]{Latin Modern Mono}
\newfontfamily{\latinfamily}[Scale=1.3]{Latin Modern Roman}
\newfontfamily{\tacteingfamily}[Scale=3]{Tacteing}

% Define new font family (have to)   <-- BUG
\newrobustcmd{\englishfont}{\englishfamily\let\currentenglish\englishfamily }
\newrobustcmd{\khmerfont}{\khmerfamily\let\currentkhmer\khmerfamily}
\newrobustcmd{\mono}{\monofamily\let\currentenglish\monofamily }
\newrobustcmd{\en}{\latinfamily\let\currentenglish\latinfamily}
\newrobustcmd{\tacteing}{\tacteingfamily\let\currentenglish\tacteingfamily}

% Initialize fonts
\khmerfont\englishfont
\setTransitionsForLatin{\currentenglish}{\currentkhmer}

% Change typewriter font family
\renewcommand{\ttfamily}{\mono}

% Fixed: math font substitution, if you use |mathpazo|
\let\temp\rmdefault
\usepackage{mathpazo}
\let\rmdefault\temp
% <==
% ==> khmer fonts
\newcommand{\kml}{
	\fontspec[ Script=Khmer, Scale=1,AutoFakeBold=1, AutoFakeSlant=0.25] 
	{Khmer OS Muol}\selectfont
}
\newcommand{\kpali}{
	\fontspec[ Scale=1, Script=Khmer,AutoFakeBold=1, AutoFakeSlant=0.25] 
	{Khmer OS Muol Pali}\selectfont
}
\newcommand{\kbk}{
	\fontspec[Script=Khmer, Scale=1.125,AutoFakeBold=1, AutoFakeSlant=0.25]
	{Khmer OS Bokor}\selectfont
}
\newcommand{\kmetal}{
	\fontspec[Script=Khmer, Scale=1.125,AutoFakeBold=1, AutoFakeSlant=0.25]
	{Khmer OS Metal Chrieng}\selectfont
}


% useful khmer-math shortcuts
\def\KHstop{\quad\text{។}}
\def\KHor{\quad\text{ឬ}\quad}
\def\KHand{\quad\text{និង}\quad}
% <==
% ==> khmer counter
%khmer number

\makeatletter
\def\khmer#1{\expandafter\@khmer\csname c@#1\endcsname}
\def\@khmer#1{\expandafter\@@khmer\number#1\@nil}
\def\@@khmer#1{%
	\ifx#1\@nil% terminate when encounter @nil
	\else%
	\ifcase#1 ០\or ១\or ២\or ៣\or ៤\or ៥\or ៦\or ៧\or ៨\or ៩\fi%
	\expandafter\@@khmer% recursively map the following characters
	\fi}

% khmer alphabet
\def\khmernumeral#1{\@@khmer#1\@nil}
\def\alpkh#1{\expandafter\@alpkh\csname c@#1\endcsname}
\def\@alpkh#1{%
	\ifcase#1% zero -> none
	\or ក\or ខ\or គ\or ឃ\or ង%
	\or ច\or ឆ\or ជ\or ឈ\or ញ%
	\or ដ\or ឋ\or ឌ\or ឍ\or ណ%
	\or ត\or ថ\or ទ\or ធ\or ន%
	\or ប\or ផ\or ព\or ភ\or ម%
	\or យ\or រ\or ល\or វ\or ស%
	\or ហ\or ឡ\or អ%
	\else%[most]
	\@ctrerr % otherwise, counter error!
	\fi}
\makeatother

%declare new enumerate counter
\AddEnumerateCounter{\alpkh}{\@alpkh}{ឈ}
\AddEnumerateCounter{\khmer}{\@khmer}{៣}
% <==

% <==
% ==> redefine the names
\def\chaptername{ជំពូកទី}
\def\axiomName{ស្វ័យសត្យ}
\def\definitionName{និយមន័យ}
\def\theoremName{ទ្រឹស្តីបទ}
\def\lemmaName{បទគន្លឹះ}
\def\propositionName{សំណើ}
\def\corollaryName{វិបាក}
\def\exampleName{ឧទាហរណ៍}
\def\exerciseName{លំហាត់}
\def\proofName{សម្រាយបញ្ជាក់}
\def\solutionName{ដំណោះស្រាយ}
\def\remarkName{សម្គាល់}
% <==
% ==> math
\usepackage{amsmath, amsthm, amsfonts, amssymb}
\usepackage{mathtools}

\mathtoolsset{centercolon} % not work when using |mathpazo|
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiterX\norm[1]\lVert\rVert{
	\ifblank{#1}{\:\cdot\:}{#1}
}
\def\set#1#2{\left\{#1 ~:~ #2\right\}}
\def\permil{\text{\hskip 0.3pt\englishfont\textperthousand}}


\DeclareMathOperator{\arccot}{cot}
\DeclareMathOperator{\arcsec}{arcsec}
\DeclareMathOperator{\arccsc}{arccsc}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\sym}{sym}
\DeclareMathOperator{\tr}{trace}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\ran}{ran}



\def\N{\mathbb{N}}
\def\Z{\mathbb{Z}}
\def\Q{\mathbb{Q}}
\def\Qc{\mathbb{Q}^{\complement}}
\def\R{\mathbb{R}}
\def\C{\mathbb{C}}
\def\F{\mathbb{F}}
\def\K{\mathbb{K}}
\def\P{\mathbb{P}}
\def\labelitemi{$\circ$}
\def\inv{^{-1}}
\def\ang#1{\left\langle#1\right\rangle}
\def\tran{^\mathrm{T}}
\renewcommand{\vec}[1]{\mathbf{#1}}
% <==
% ==> mdframe theorem
\usepackage{thmtools}
\usepackage[framemethod=TikZ]{mdframed}

% ==> Axiom
\mdfdefinestyle{mdAxiomStyle}{
	roundcorner = 10pt,
	linewidth=1.125pt,
	skipabove=12pt,
	innerbottommargin=9pt,
	skipbelow=2pt,
	nobreak=true,
	linecolor=blue,
	backgroundcolor=TealBlue!5,
}
\declaretheoremstyle[
	headfont=\bfseries\color{MidnightBlue},
	bodyfont=\itshape,
	mdframed={style=mdAxiomStyle},
	headpunct={\\[3pt]},
	postheadspace={0pt},
	notefont=\bfseries\itshape\color{gray!50!blue},
	notebraces={~(}{)},
]{mdAxiom}
% <==
% ==> Definition
\mdfdefinestyle{mdDefinitionStyle}{
	roundcorner = 10pt,
	linewidth=1.125pt,
	skipabove=12pt,
	innerbottommargin=9pt,
	skipbelow=2pt,
	nobreak=true,
	linecolor=blue,
	backgroundcolor=TealBlue!5,
}
\declaretheoremstyle[
	headfont=\bfseries\color{MidnightBlue},
	bodyfont=\itshape,
	mdframed={style=mdDefinitionStyle},
	headpunct={\\[3pt]},
	postheadspace={0pt},
	notefont=\bfseries\itshape\color{gray!50!blue},
	notebraces={~(}{)},
]{mdDefinition}
% <==
% ==> Theorem
\mdfdefinestyle{mdTheoremStyle}{%
	linewidth=1pt,
	skipabove=12pt,
	frametitleaboveskip=5pt,
	frametitlebelowskip=0pt,
	skipbelow=2pt,
	innertopmargin=5pt,
	innerbottommargin=8pt,
	nobreak=true,
	linecolor=RawSienna!40,
	backgroundcolor=Salmon!10,
}
\declaretheoremstyle[
	headfont=\bfseries\color{RawSienna},
  headindent=0pt,
	bodyfont=\itshape,
	mdframed={style=mdTheoremStyle},
	notefont=\normalfont\itshape\small\color{RawSienna},
	notebraces={~$\big\langle$}{$\big\rangle$},
	headpunct={\\[3pt]},
	postheadspace={0pt},
]{mdTheorem}
% <==
% ==> Exercise
\mdfdefinestyle{mdExerciseStyle}{%
	skipabove=8pt,
	skipbelow=2pt,
	linewidth=1pt,
	rightline=true,
	leftline=true,
	topline=true,
	bottomline=true,
	linecolor=ForestGreen!20,
	backgroundcolor=ForestGreen!20
}
\declaretheoremstyle[
	headfont=\bfseries\color{ForestGreen!70!black},
	bodyfont=\normalfont,
	headindent=0pt,
	spaceabove=2pt,
	spacebelow=2pt,
	mdframed={style=mdExerciseStyle},
	notefont=\small\bfseries\itshape\color{DarkGreen},
	notebraces={~(}{)},
	headpunct={ },
]{mdExercise}
% <==
% ==> Proof
\declaretheoremstyle[
	spaceabove=6pt,
	spacebelow=6pt,
	headindent=0pt,
	headfont=\normalfont\color{magenta!70!blue},
	bodyfont = \normalfont,
	postheadspace=1em,
	qed=$\color{magenta!70!black}\blacksquare$,
	headpunct={ },
]{mdProof}
% <==

% ==> Declaring the theorems
\declaretheorem{axiom}[style=mdAxiom, name={\kml\axiomName}, numberwithin=chapter]
\declaretheorem[style=mdDefinition, name={\kml\definitionName}, sibling=axiom]{definition}

\declaretheorem{theorem}[style=mdTheorem, name={\theoremName},numberwithin=chapter]
\declaretheorem{lemma}[style=mdTheorem, name={\lemmaName},sibling=theorem]
\declaretheorem{proposition}[style=mdTheorem, name={\propositionName}, sibling=theorem]
\declaretheorem{corollary}[style=mdTheorem, sibling=theorem, name={\corollaryName}]

\declaretheorem{example}[name={\exampleName},style=mdExercise, numberwithin=chapter]
\declaretheorem{exercise}[name={\exerciseName},style=mdExercise, sibling=example]

%% Proof
\declaretheorem[name={\bfseries\proofName},numbered=no,style=mdProof]{Proof}
\renewenvironment{proof}{\begin{Proof}}{\end{Proof}}
\declaretheorem[name={\itshape\solutionName},numbered=no,style=mdProof]{solution}
% <==
% <==
% ==> tweaking memmoir
\checkandfixthelayout
%\setlrmarginsandblock{2cm}{8cm}{*}
%\setulmarginsandblock{3cm}{*}{1.5}


\makepagestyle{myruled}
\makeheadrule {myruled}{\textwidth}{\normalrulethickness}
\makefootrule {myruled}{\textwidth}{\normalrulethickness}{\footruleskip}
\makeevenhead {myruled}{}{\small\itshape\leftmark} {}
\makeoddhead  {myruled}{}{\small\itshape\rightmark}{}
\makeevenfoot {myruled}{}{\small\thepage} {}
\makeoddfoot  {myruled}{}{\small\thepage} {}

\makeatletter % because of \@chapapp
\makepsmarks{myruled}{
  \nouppercaseheads
  \createmark{chapter}{both}{shownumber}{}{. \space}
  \createmark{section}{right}{shownumber}{}{. \space}
  \createmark{subsection}{right}{shownumber}{}{. \space}
  \createmark{subsubsection}{right}{shownumber}{}{. \ }
  \createplainmark {toc} {both} {\contentsname} 
  \createplainmark {lof} {both} {\listfigurename}
  \createplainmark {lot} {both} {\listtablename} 
  \createplainmark {bib} {both} {\bibname} 
  \createplainmark {index} {both} {\indexname} 
  \createplainmark {glossary} {both} {\glossaryname}
}
\makeatother
\setsecnumdepth{subsubsection}
\pagestyle{myruled}

\renewcommand{\headheight}{17pt}
% <==
